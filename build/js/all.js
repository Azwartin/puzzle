"use strict";function Game(){this.cntX=2,this.cntY=2,this.field=[],this.setCountX=function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;t>0?this.cntX=t:this.cntX=i},this.setCountY=function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;t>0?this.cntY=t:this.cntY=i},this.mixPuzzle=function(){var t,i,e=[],n=this.cntX*this.cntY;for(this.field=[],console.log(this.cntX),t=0;t<n;t++)e.push(t);for(t=0;t<this.cntX;t++)for(this.field[t]=[],i=0;i<this.cntY;i++)this.field[t][i]=e.splice(Math.trunc(Math.random()*e.length),1)[0];return console.log(this.field),this.field},this.checkWin=function(){var t,i,e=this.field.length,n=this.field[0].length;for(t=0;t<e;t++)for(i=0;i<n;i++)if(this.field[t][i]!=t*n+i)return!1;return!0},this.getChunk=function(t,i){return this.field[t][i]},this.swap=function(t,i){var e=this.field[t.i][t.j];this.field[t.i][t.j]=this.field[i.i][i.j],this.field[i.i][i.j]=e},this.chunkToPosition=function(t){return{i:Math.trunc(t/this.cntY),j:t%this.cntY}}}function Loader(){var t=null;this.load=function(i){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!i.type.match(/image.*/))return void alert("The dropped file is'nt an image");var n=new FileReader;n.addEventListener("load",function(i){t=new Image,t.addEventListener("load",function(){console.log("Loaded"),e&&e(this)}),t.src=i.target.result}),n.readAsDataURL(i)},this.getImage=function(){return t}}function Render(t,i,e){var n=t.getContext("2d"),o=i.getContext("2d"),h=t.getBoundingClientRect();this.blockWidth=0,this.blockHeight=0,this.render=function(i){var o,s,c,l,d,r,a=i.length,u=i[0].length;for(this.blockWidth=e.width/a,this.blockHeight=e.height/u,t.width=e.width,t.height=e.height,h=t.getBoundingClientRect(),o=0;o<a;o++)for(s=0;s<u;s++)d=Math.trunc(i[o][s]/u)*this.blockWidth,r=i[o][s]%u*this.blockHeight,c=o*this.blockWidth,l=s*this.blockHeight,n.drawImage(e,d,r,this.blockWidth,this.blockHeight,c,l,this.blockWidth,this.blockHeight)},this.renderIcon=function(t,n,h,s){""!=i.style.display&&"none"!=i.style.display||(i.width=this.blockWidth,i.height=this.blockHeight,o.drawImage(e,t*this.blockWidth,n*this.blockHeight,this.blockWidth,this.blockHeight,0,0,this.blockWidth,this.blockHeight),i.style.display="block"),i.style.top=s+"px",i.style.left=h+"px"},this.moveIcon=function(t,e){""!=i.style.display&&"none"!=i.style.display&&(i.style.top=e+"px",i.style.left=t+"px")},this.hideIcon=function(){console.log("hide"),i.style.display="none"},this.swap=function(t,i,o,h){n.drawImage(e,o.i*this.blockWidth,o.j*this.blockHeight,this.blockWidth,this.blockHeight,i.i*this.blockWidth,i.j*this.blockHeight,this.blockWidth,this.blockHeight),n.drawImage(e,h.i*this.blockWidth,h.j*this.blockHeight,this.blockWidth,this.blockHeight,t.i*this.blockWidth,t.j*this.blockHeight,this.blockWidth,this.blockHeight)},this.coordinateToPosition=function(t,i){return console.log(t+" "+i),console.log(h.left),console.log(h.top),{i:Math.trunc((t-h.left)/this.blockWidth),j:Math.trunc((i-h.top)/this.blockHeight)}}}!function(){window.addEventListener("load",function(){function t(t,i){var e=parseInt(t);return e==t?e:i}function i(i){i.length>0&&r.load(i[0],function(i){e=new Render(o,h,i),a.setCountX(t(l.value,u)),a.setCountY(t(d.value,u)),e.render(a.mixPuzzle()),o.addEventListener("mousedown",function(t){var i=(r.getImage(),e.coordinateToPosition(t.pageX,t.pageY)),o=a.getChunk(i.i,i.j);n=i,console.log(i),i=a.chunkToPosition(o),e.renderIcon(i.i,i.j,t.pageX,t.pageY)}),window.addEventListener("mousemove",function(t){e.moveIcon(t.pageX,t.pageY)}),s.addEventListener("click",function(){r.getImage()&&(a.setCountX(t(l.value,u)),a.setCountY(t(d.value,u)),e.render(a.mixPuzzle()))}),window.addEventListener("mouseup",function(t){if(e.hideIcon(),n){var i=e.coordinateToPosition(t.pageX,t.pageY),o=a.chunkToPosition(a.getChunk(n.i,n.j)),h=a.chunkToPosition(a.getChunk(i.i,i.j));e.swap(n,i,o,h),a.swap(n,i),n=!1,a.checkWin()&&alert("Собрано!")}})})}var e,n,o=document.querySelector(".game-canvas"),h=document.querySelector(".icon-canvas"),s=document.querySelector(".btn-mix"),c=document.querySelector(".btn-load"),l=document.querySelector(".count-chunk-x"),d=document.querySelector(".count-chunk-y"),r=new Loader,a=new Game,u=5;o.addEventListener("dragover",function(t){t.preventDefault()},!0),o.addEventListener("drop",function(t){t.preventDefault(),i(t.dataTransfer.files)},!0),c.addEventListener("change",function(t){i(t.target.files)},!1)})}();